<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>3Dファイルを表示する</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.8.6/dist/nipplejs.min.js"></script>
    <style>
        #content {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        #canvas-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        #joystick-container {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 150px;
            height: 150px;
        }
        #angle-joystick-container {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 150px;
            height: 150px;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <input type="file" id="fileInput" />
    <div id="content">
        <div id="canvas-container"></div>
        <div id="joystick-container"></div>
        <div id="angle-joystick-container"></div>
        <div id="controls">
            <button id="reset">リセット</button>
        </div>
    </div>

    <script>
        let object; // グローバルスコープでオブジェクトを参照できるようにする
        let camera, scene, renderer;
        const initialCameraPosition = { x: 0, y: 5, z: 5 }; // カメラの初期位置

        // カメラの動作フラグ
        let moveCamera = { x: 0, z: 0 };
        let rotateCamera = { x: 0, y: 0 };

        // ダブルクリックを無効にするためのイベントリスナーを追加
        document.getElementById('content').addEventListener('dblclick', function(event) {
            event.preventDefault();
        });

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;

                // Three.jsのシーンとカメラ、レンダラーのセットアップ
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                renderer = new THREE.WebGLRenderer();
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.getElementById('canvas-container').innerHTML = ''; // 以前の内容をクリア
                document.getElementById('canvas-container').appendChild(renderer.domElement);

                // 光源を追加
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(1, 1, 1).normalize();
                scene.add(light);

                const ambientLight = new THREE.AmbientLight(0x404040); // 環境光
                scene.add(ambientLight);

                // OBJLoaderを使用して.objデータを読み込む
                const objLoader = new THREE.OBJLoader();
                object = objLoader.parse(text);
                scene.add(object);

                // カメラの位置を高くして少し見下ろす角度に設定
                resetCameraPosition();

                animate();
            };

            reader.readAsText(file);
        });

        // ジョイスティックのセットアップ
        const moveJoystick = nipplejs.create({
            zone: document.getElementById('joystick-container'),
            mode: 'static',
            position: { left: '50px', bottom: '50px' },
            color: 'blue'
        });

        const angleJoystick = nipplejs.create({
            zone: document.getElementById('angle-joystick-container'),
            mode: 'static',
            position: { right: '50px', bottom: '50px' },
            color: 'red'
        });

        // ジョイスティックの動作に応じてカメラを移動
        moveJoystick.on('move', function (evt, data) {
            if (data && data.vector) {
                moveCamera.x = data.vector.x;  // ジョイスティックからのx方向の動作を保存
                moveCamera.z = -data.vector.y; // z方向も保存（反転）
            }
        });

        moveJoystick.on('end', function () {
            // 操作が終わったら移動量をリセット
            moveCamera.x = 0; 
            moveCamera.z = 0; 
        });

        // ジョイスティックの動作に応じてカメラの角度を変更
        angleJoystick.on('move', function (evt, data) {
            if (data && data.vector) {
                rotateCamera.y = -data.vector.x * 0.02; // 左右操作を反転させるためにマイナスを付ける
                rotateCamera.x = data.vector.y * 0.02;
            }
        });

        angleJoystick.on('end', function () {
            // 操作が終わったら角度の変化をリセット
            rotateCamera.x = 0; 
            rotateCamera.y = 0; 
        });

        // リセットボタンのイベントリスナー
        document.getElementById('reset').addEventListener('click', function() {
            resetCameraPosition();
        });

        // カメラ位置と角度を初期状態にリセットする関数
        function resetCameraPosition() {
            camera.position.set(initialCameraPosition.x, initialCameraPosition.y, initialCameraPosition.z);
            camera.lookAt(0, 0, 0); // 原点を見下ろす
            camera.rotation.set(0, 0, 0); // カメラの回転もリセット
            camera.fov = 75; // FOVもリセット
            camera.updateProjectionMatrix(); // プロジェクションマトリックスを更新
        }

        // アニメーションループ
        function animate() {
            requestAnimationFrame(animate);

            // カメラの位置を更新
            camera.position.x += moveCamera.x * 0.1; // 移動量をカメラの位置に適用
            camera.position.z += moveCamera.z * 0.1;

            // カメラの回転を更新
            camera.rotation.y += rotateCamera.y; // y方向の回転を適用
            camera.rotation.x += rotateCamera.x; // x方向の回転を適用

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
